# -*- mode: sh -*-

MAIL_CMD=mutt

NEW_USER_EMAIL_SUBJECT="Login details for $NGGROUP_SERVER_NAME"
NEW_USER_EMAIL_TEMPLATE="
Hi ${NGGROUP_EMAIL_NAME},

Please find attached your login details for ${NGGROUP_SERVER_NAME}.

Details are as follows:

Username: ${NGGROUP_EMAIL_USERNAME}
Password: ${NGGROUP_EMAIL_PASSWORD}
Sites available:
[links]
${NGGROUP_EMAIL_LINKS}
[/links]

Please note that this is an automated message and as such, any replies are not attended to. Please email sysadmin at ${NGGROUP_SERVER_ADMIN_EMAIL} instead.
"

as_li () {
    echo "<li>" "$1" "</li>"
}

as_link () {
    echo "<a href='$NGGROUP_SERVER_ROOT_URL/$1'>$1 on $NGGROUP_SERVER_NAME</a>"
}

email () {
    if [ ! $(which "$MAIL_CMD") ];
    then
	echo "Error: cannot email - no \`mail\` installed"
	return 1
    fi


    NGGROUP_EMAIL_ADDRESS="$2"
    case $1 in
	new_user )
	    NGGROUP_EMAIL_NAME="$3"
	    NGGROUP_EMAIL_USERNAME="$4"
	    NGGROUP_EMAIL_PASSWORD="$5"
	    NGGROUP_EMAIL_LINKS=()
	    NGGROUP_EMAIL_LINKS_COUNT=0
	    for link in $6;
	    do
		NGGROUP_EMAIL_LINKS[$NGGROUP_EMAIL_LINKS_COUNT]=$(as_li "$(as_link $link)")
		NGGROUP_EMAIL_LINKS_COUNT=$(( $NGGROUP_EMAIL_LINKS_COUNT + 1 ))
	    done

	    NEW_USER_EMAIL_TEMPLATE="
<p>Hi ${NGGROUP_EMAIL_NAME},</p>

<p>Please find attached your login details for <em>${NGGROUP_SERVER_NAME}</em>.</p>

<p>Details are as follows:</p>
<ul>
    <li>Username: <code>${NGGROUP_EMAIL_USERNAME}</code></li>
    <li>Password: <code>${NGGROUP_EMAIL_PASSWORD}</code></li>
</ul>

<p>Sites available:</p>
<ul>
${NGGROUP_EMAIL_LINKS[@]}
</ul>
</p>

<p>Please note that this is an automated message and as such, any replies are not attended to. Please email sysadmin at ${NGGROUP_SERVER_ADMIN_EMAIL} instead.</p>
"
	    echo "$NEW_USER_EMAIL_TEMPLATE" | "$MAIL_CMD" -e "set content_type=text/html" -c "$NGGROUP_SERVER_ADMIN_EMAIL" -s "$NEW_USER_EMAIL_SUBJECT" "$NGGROUP_EMAIL_ADDRESS"
	    ;;
    esac
}
