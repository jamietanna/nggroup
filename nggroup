#!/bin/bash

# TODO: need to do *all* validation

debug() { echo "$@" 1>&2; }

#HTPASS_DIR=/etc/nginx/htpasswd
HTPASS_DIR=.
SITES_DIR=$HTPASS_DIR/sites
SITES_DIR_FORMAT="$SITES_DIR/.%s.rules"
USER_DIR=$HTPASS_DIR/users
USER_DIR_FORMAT="$USER_DIR/%s"
USER_RULE_FORMAT="%s"
GROUP_DIR=$HTPASS_DIR/groups
GROUP_DIR_FORMAT="$GROUP_DIR/%s"
GROUP_RULE_FORMAT="@%s"
TMP_FILE=/tmp/nggrouptmp

if [ "$(id -u)" != "0" ];
then
    echo "Error; Must run as root."
    exit 1
fi


mkdir -p $HTPASS_DIR
mkdir -p $SITES_DIR
mkdir -p $USER_DIR
mkdir -p $GROUP_DIR


site () {
    local site_file
    site_file=$(printf $SITES_DIR_FORMAT $2)
    case $1 in
	siteadd )
	    if [ -e $site_file ];
	    then
		echo "Error: Site already exists."
		exit 1
	    fi
	    touch $site_file
	    ;;
	sitedel )
	    if [ ! -e $site_file ];
	    then
		echo "Error: Site does not exist."
		exit 1
	    fi
	    rm $site_file
	    ;;
	sitemod )
	    site_file=$(printf $SITES_DIR_FORMAT $2)
	    group_file=$(printf $GROUP_DIR_FORMAT $4)
	    if [ ! -e $group_file ];
	    then
		echo "Error: Group does not exist"
		exit 1
	    fi

	    if [ ! -e $site_file ];
	    then
		echo "Error: Site does not exist"
		exit 1
	    fi

	    # check if the group exists in the site's rules
	    grep $4 $site_file > /dev/null
	    group_in_site=$?

	    case $3 in
		a )
		    # check if already there
		    if [ 0 -eq $group_in_site ] ;
		    then
			# TODO: more meaningful messages - i.e. Group 'test'
			echo "Error: Group already exists in site"
			exit 1
		    fi

		    echo $4 >> $site_file
		    ;;
		d )
		    if [ 1 -eq $group_in_site ] ;
		    then
			# TODO: rethink error codes?
			echo "Error: Group does not exist in site"
			exit 1
		    fi

		    sed -i /$4/d $site_file
		    ;;
	    esac
	    ;;
    esac
}

user () {
    local file
    file=$(printf $USER_DIR_FORMAT $2)
    
    case $1 in
	useradd )
	    contents=$(htpasswd -nb $2 $3)
	    if [ -e $file ];
	    then
		echo "Error: user already exists."
		exit 1
	    fi

	    echo $contents > $file
	    ;;
	userdel )
	    if [ ! -e $file ];
	    then
		echo "Error: User does not exist."
		exit 1
	    fi

	    rm $file
    esac
}

group () {
    local group_file
    group_file=$(printf $GROUP_DIR_FORMAT $2)
    
    case $1 in
	groupadd )
	    if [ -e $group_file ];
	    then
		echo "Error: group already exists."
		exit 1
	    fi

	    touch $group_file
	    ;;
	groupdel )
	    if [ ! -e $group_file ];
	    then
		echo "Error: Group does not exist."
		exit 1
	    fi

	    rm $group_file
	    ;;
	groupmod )
	    if [ ! -e $group_file ];
	    then
		echo "Error: Group does not exist"
		exit 1
	    fi

	    local context
	    local context_file
	    local context_dir_format
	    local context_rule_format
	    local context_friendly

	    context=$(echo $4 | cut -c 2-)

	    case $4 in
		u* )
		    context_dir_format=$USER_DIR_FORMAT
		    context_rule_format=$USER_RULE_FORMAT
		    context_friendly=User
		    ;;
		g* )
		    context_dir_format=$GROUP_DIR_FORMAT
		    context_rule_format=$GROUP_RULE_FORMAT
		    context_friendly=Group
		    ;;
	    esac

	    context_file=$(printf $context_dir_format $context)
	    context_insert=$(printf $context_rule_format $context)
	    
	    if [ ! -e $context_file ];
	    then
		printf "Error: %s does not exist.\n" $context_friendly
		exit 1
	    fi
	    
	    grep $context $group_file > /dev/null
	    context_in_file=$?

	    case $3 in
		a )
		    if [ 0 -eq $context_in_file ];
		    then
			printf "Error: %s is already part of the group.\n" $context_friendly
			exit 1
		    else
			echo $context_insert >> $group_file
		    fi
		    ;;
		d )
		    if [ 0 -eq $context_in_file ];
		    then
			sed -i /$context_insert/d $group_file
		    else
			printf "Error: %s does not exist in the group.\n" $context_friendly
			exit 1
		    fi
		    ;;
	    esac

	    ;;
    esac
}

case $1 in
    site* )
	site $@
	;;

    user* )
	user $@
	;;

    group* )
	group $@
	;;
esac

