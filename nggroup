#!/bin/bash

debug() { echo "$@" 1>&2; }

#HTPASS_DIR=/etc/nginx/htpasswd
HTPASS_DIR=.
SITES_DIR=$HTPASS_DIR/sites
SITES_DIR_FORMAT="$SITES_DIR/.%s.rules"
USER_DIR=$HTPASS_DIR/users
USER_DIR_FORMAT="$USER_DIR/%s"
TMP_FILE=/tmp/nggrouptmp

if [ "$(id -u)" != "0" ];
then
    echo "Error; Must run as root."
fi

mkdir -p $HTPASS_DIR
mkdir -p $SITES_DIR
mkdir -p $USER_DIR


site () {
    local file
    file=$(printf $SITES_DIR_FORMAT $2)
    case $1 in
	siteadd )
	    if [ -e $file ];
	    then
		echo "Error: Site already exists"
		exit 1
	    fi
	    touch $file
	    ;;
	sitedel )
	    if [ ! -e $file ];
	    then
		echo "Error: Site does not exist"
		exit 1
	    fi
	    rm $(printf $SITES_DIR_FORMAT $2)
	    ;;
    esac
}

user () {
    local file
    file=$(printf $USER_DIR_FORMAT $2)
    
    case $1 in
	useradd )
	    contents=$(htpasswd -nb $2 $3)
	    if [ -e $file ];
	    then
		echo "Error: user already exists."
		exit 1
	    fi

	    echo $contents > $file
	    ;;
    esac
}

case $1 in
    site* )
	site $@
	;;

    user* )
	user $@
	;;
esac

